<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug JSONL Loader</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            overflow-x: auto;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Debug JSONL Loader</h1>
    
    <div>
        <label for="fileInput">Select JSONL File:</label>
        <input type="file" id="fileInput" accept=".jsonl">
    </div>
    
    <div id="output"></div>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const output = document.getElementById('output');
            output.innerHTML = '<h2>Loading file...</h2>';
            
            try {
                const text = await file.text();
                const lines = text.trim().split('\n');
                
                let html = `<h2 class="success">File loaded successfully!</h2>`;
                html += `<p><strong>File name:</strong> ${file.name}</p>`;
                html += `<p><strong>File size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>`;
                html += `<p><strong>Total lines:</strong> ${lines.length}</p>`;
                
                // Parse first 5 lines
                html += '<h3>First 5 lines parsed:</h3>';
                const parsedLines = [];
                
                for (let i = 0; i < Math.min(5, lines.length); i++) {
                    try {
                        const parsed = JSON.parse(lines[i]);
                        parsedLines.push(parsed);
                        
                        html += `<h4>Line ${i + 1}:</h4>`;
                        html += '<pre>' + JSON.stringify(parsed, null, 2) + '</pre>';
                        
                        if (i === 0) {
                            html += '<p><strong>Fields found:</strong> ' + Object.keys(parsed).join(', ') + '</p>';
                            html += '<p><strong>bucket_type value:</strong> ' + 
                                    (parsed.bucket_type !== undefined ? `"${parsed.bucket_type}" (type: ${typeof parsed.bucket_type})` : 'MISSING!') + 
                                    '</p>';
                        }
                    } catch (e) {
                        html += `<p class="error">Error parsing line ${i + 1}: ${e.message}</p>`;
                        html += '<pre>' + lines[i].substring(0, 200) + '...</pre>';
                    }
                }
                
                // Check bucket_type distribution
                const bucketTypes = {};
                let missingCount = 0;
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);
                        if (data.bucket_type !== undefined && data.bucket_type !== null) {
                            bucketTypes[data.bucket_type] = (bucketTypes[data.bucket_type] || 0) + 1;
                        } else {
                            missingCount++;
                        }
                    } catch (e) {
                        // Skip parse errors
                    }
                }
                
                html += '<h3>Bucket Type Distribution:</h3>';
                html += '<table>';
                html += '<tr><th>Bucket Type</th><th>Count</th></tr>';
                
                for (const [type, count] of Object.entries(bucketTypes)) {
                    html += `<tr><td>${type}</td><td>${count}</td></tr>`;
                }
                
                if (missingCount > 0) {
                    html += `<tr><td class="error">Missing/Undefined</td><td>${missingCount}</td></tr>`;
                }
                
                html += '</table>';
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<p class="error">Error reading file: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
