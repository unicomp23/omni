<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bucket Analysis Viewer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .btn-group {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .btn {
            background: white;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-right: 1px solid #ddd;
        }
        
        .btn:last-child {
            border-right: none;
        }
        
        .btn.active {
            background: #667eea;
            color: white;
        }
        
        .btn:hover:not(.active) {
            background: #f8f9fa;
        }
        
        .stats {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .chart-svg {
            width: 100%;
            min-width: 800px;
            height: 400px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }
        
        .grid-line {
            stroke: #f0f0f0;
            stroke-width: 1;
        }
        
        .axis-line {
            stroke: #333;
            stroke-width: 1;
        }
        
        .axis-text {
            font-size: 10px;
            fill: #666;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .data-line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .data-point {
            r: 3;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .data-point:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Bucket Analysis Viewer</h1>
        <p>Interactive visualization of latency percentiles over time</p>
    </div>
    
    <div class="controls">
        <div class="btn-group">
            <button class="btn active" onclick="switchView('5min')">5-Minute Data</button>
            <button class="btn" onclick="switchView('1hr')">1-Hour Data</button>
        </div>
    </div>
    
    <div class="stats" id="stats">
        <div class="stat-item">
            <div class="stat-value" id="total-points">-</div>
            <div class="stat-label">Data Points</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="time-range">-</div>
            <div class="stat-label">Time Range</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avg-latency">-</div>
            <div class="stat-label">Avg P50 (ms)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="max-p99">-</div>
            <div class="stat-label">Max P99 (ms)</div>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">Latency Percentiles Over Time</div>
        <svg class="chart-svg" id="chart"></svg>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #2563eb;"></div>
                <span>P50 (Median)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #059669;"></div>
                <span>P90</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #d97706;"></div>
                <span>P95</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc2626;"></div>
                <span>P99</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #7c2d12;"></div>
                <span>P99.9</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #581c87;"></div>
                <span>P99.99</span>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">Loading data...</div>
    
    <div class="tooltip" id="tooltip" style="display: none;"></div>
    
    <script>
        let allData = [];
        let currentView = '5min';
        let chart = null;
        
        // Colors for different percentiles
        const colors = {
            'p50_ms': '#2563eb',
            'p90_ms': '#059669',
            'p95_ms': '#d97706',
            'p99_ms': '#dc2626',
            'p99_9_ms': '#7c2d12',
            'p99_99_ms': '#581c87'
        };
        
        const percentileLabels = {
            'p50_ms': 'P50',
            'p90_ms': 'P90',
            'p95_ms': 'P95',
            'p99_ms': 'P99',
            'p99_9_ms': 'P99.9',
            'p99_99_ms': 'P99.99'
        };
        
        async function loadData() {
            try {
                const response = await fetch('bucket_analysis.jsonl');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                const lines = text.trim().split('\n');
                
                allData = lines.map(line => {
                    try {
                        const data = JSON.parse(line);
                        data.start_time_date = new Date(data.start_time);
                        return data;
                    } catch (e) {
                        console.warn('Failed to parse line:', line);
                        return null;
                    }
                }).filter(d => d !== null);
                
                console.log(`Loaded ${allData.length} data points`);
                document.getElementById('loading').style.display = 'none';
                renderChart();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <strong>Error loading data:</strong> ${error.message}
                        <br><br>
                        Make sure the bucket_analysis.jsonl file is in the same directory as this HTML file.
                    </div>
                `;
            }
        }
        
        function switchView(view) {
            if (currentView === view) return;
            
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderChart();
        }
        
        function getFilteredData() {
            return allData.filter(d => d.bucket_type === currentView)
                          .sort((a, b) => a.start_time_date - b.start_time_date);
        }
        
        function updateStats(data) {
            if (data.length === 0) return;
            
            const totalPoints = data.length;
            const timeRange = data.length > 0 ? 
                `${formatDate(data[0].start_time_date)} - ${formatDate(data[data.length - 1].end_time_date || data[data.length - 1].start_time_date)}` : '-';
            
            const avgP50 = data.reduce((sum, d) => sum + d.p50_ms, 0) / data.length;
            const maxP99 = Math.max(...data.map(d => d.p99_ms));
            
            document.getElementById('total-points').textContent = totalPoints.toLocaleString();
            document.getElementById('time-range').textContent = timeRange;
            document.getElementById('avg-latency').textContent = avgP50.toFixed(1);
            document.getElementById('max-p99').textContent = maxP99.toFixed(1);
        }
        
        function formatDate(date) {
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function renderChart() {
            const data = getFilteredData();
            updateStats(data);
            
            if (data.length === 0) {
                document.getElementById('chart').innerHTML = '<text x="50%" y="50%" text-anchor="middle" class="axis-text">No data available for this view</text>';
                return;
            }
            
            const svg = document.getElementById('chart');
            const rect = svg.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            
            const margin = { top: 20, right: 80, bottom: 80, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Clear previous content
            svg.innerHTML = '';
            
            // Create scales
            const timeExtent = d3.extent(data, d => d.start_time_date);
            const xScale = d3.scaleTime()
                .domain(timeExtent)
                .range([0, chartWidth]);
            
            // Find max value across all percentiles
            const percentiles = ['p50_ms', 'p90_ms', 'p95_ms', 'p99_ms', 'p99_9_ms', 'p99_99_ms'];
            const maxValue = d3.max(data, d => d3.max(percentiles, p => d[p]));
            
            const yScale = d3.scaleLinear()
                .domain([0, maxValue * 1.05])
                .range([chartHeight, 0]);
            
            // Create main group
            const g = d3.select(svg)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Add grid lines
            const xTicks = xScale.ticks(10);
            const yTicks = yScale.ticks(8);
            
            // Y grid lines
            g.selectAll('.grid-line-y')
                .data(yTicks)
                .enter()
                .append('line')
                .attr('class', 'grid-line')
                .attr('x1', 0)
                .attr('x2', chartWidth)
                .attr('y1', d => yScale(d))
                .attr('y2', d => yScale(d));
            
            // X grid lines
            g.selectAll('.grid-line-x')
                .data(xTicks)
                .enter()
                .append('line')
                .attr('class', 'grid-line')
                .attr('x1', d => xScale(d))
                .attr('x2', d => xScale(d))
                .attr('y1', 0)
                .attr('y2', chartHeight);
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%m/%d %H:%M')))
                .selectAll('text')
                .attr('class', 'axis-text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
            
            g.append('g')
                .call(d3.axisLeft(yScale))
                .selectAll('text')
                .attr('class', 'axis-text');
            
            // Add axis labels
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (chartHeight / 2))
                .attr('dy', '1em')
                .attr('class', 'axis-text')
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .text('Latency (ms)');
            
            g.append('text')
                .attr('transform', `translate(${chartWidth / 2}, ${chartHeight + margin.bottom - 10})`)
                .attr('class', 'axis-text')
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .text('Time');
            
            // Create line generator
            const line = d3.line()
                .x(d => xScale(d.start_time_date))
                .y((d, i, arr) => {
                    const percentile = arr.percentile;
                    return yScale(d[percentile]);
                })
                .curve(d3.curveMonotoneX);
            
            // Draw lines for each percentile
            percentiles.forEach(percentile => {
                const lineData = data.map(d => ({ ...d, percentile }));
                lineData.percentile = percentile;
                
                g.append('path')
                    .datum(lineData)
                    .attr('class', 'data-line')
                    .attr('d', line)
                    .style('stroke', colors[percentile])
                    .style('opacity', 0.8);
                
                // Add data points for hover
                g.selectAll(`.point-${percentile}`)
                    .data(data)
                    .enter()
                    .append('circle')
                    .attr('class', `data-point point-${percentile}`)
                    .attr('cx', d => xScale(d.start_time_date))
                    .attr('cy', d => yScale(d[percentile]))
                    .attr('fill', colors[percentile])
                    .on('mouseover', function(event, d) {
                        showTooltip(event, d, percentile);
                    })
                    .on('mouseout', hideTooltip);
            });
        }
        
        function showTooltip(event, d, percentile) {
            const tooltip = document.getElementById('tooltip');
            const rect = document.body.getBoundingClientRect();
            
            tooltip.innerHTML = `
                <strong>${percentileLabels[percentile]}: ${d[percentile].toFixed(2)} ms</strong><br>
                Time: ${formatDate(d.start_time_date)}<br>
                Duration: ${currentView}<br>
                Messages: ${d.total_messages.toLocaleString()}<br>
                Min: ${d.min_ms.toFixed(2)} ms<br>
                Max: ${d.max_ms.toFixed(2)} ms<br>
                Avg: ${d.avg_ms.toFixed(2)} ms
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }
        
        // Load D3.js library
        const script = document.createElement('script');
        script.src = 'https://d3js.org/d3.v7.min.js';
        script.onload = loadData;
        document.head.appendChild(script);
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (allData.length > 0) {
                    renderChart();
                }
            }, 250);
        });
    </script>
</body>
</html>